name: Publish to PyPI

on:
  release:
    types: [published]

jobs:
  publish:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install MinGW
        run: choco install mingw -y

      - name: Compile libcortex.dll
        run: |
          cd c/src
          gcc -shared -o libcortex.dll libcortex.c
          copy libcortex.dll ..\..\src\cortex\core\libcortex.dll

      - name: Clean dist
        run: |
          if (Test-Path dist) { Remove-Item -Recurse -Force dist }

      - name: Compile libcortex.dll
        run: |
          cd c/src
          gcc -shared -o libcortex.dll libcortex.c
          copy libcortex.dll ..\..\src\cortex\core\libcortex.dll

      - name: Show pyproject.toml
        run: type pyproject.toml

      - name: Build package
        run: uv build

      - name: Show dist contents
        run: dir dist\

      - name: Publish to PyPI
        run: uv publish
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI_TOKEN }}